import{U as v,u as se,b as D,S as ie,a as ne}from"./chunk-FCEISMFM-z5BU_Q64.js";import{C as E,R as L,I as T}from"./chunk-PYIO3TDQ-D8Zv8hXV.js";import{D as oe}from"./chunk-ZF4OL2GU-BRoSbw-F.js";import{a1 as te,ao as O,a3 as h,af as A,ad as F,R as ce,ar as ae,j as n,b as le,r as M,a8 as de,a9 as ue,g as pe,i as me,l as fe,t as N,B as k}from"./index-DVDzS5zo.js";import"./chunk-BNLHRJ2A-B9cujPUv.js";import{d as ge,c as _e}from"./chunk-CUT7UDIA-DFt7s1wX.js";import{c as R}from"./chunk-6GU6IDUA-CDc7wW5L.js";import{K as he}from"./chunk-6HTZNHPT-CRPKDwNX.js";import{R as y,u as B,a as ye,S as Se}from"./chunk-6DAFMWMA-DOplJBJA.js";import"./chunk-FSMQADBD-Dkr3W4bN.js";import"./chunk-MWVM4TYO-bKUcYSnf.js";import"./index.esm-DYlfXC4f.js";import"./x-mark-mini-Lz0IIf_4.js";import"./Trans-gbTvuGyt.js";import"./currency-input-BnpBEQOQ.js";import"./index-hgvacr-t.js";import"./checkbox-VBH6vfOi.js";import"./prompt-BT4Q14j5.js";var xe=te({region_prices:O(h(),h().or(A()).optional()),currency_prices:O(h(),h().or(A()).optional()),conditional_region_prices:O(h(),F(v)),conditional_currency_prices:O(h(),F(v))});function Pe({shippingOption:s}){const{t:e}=le(),{handleSuccess:u}=B(),{getIsOpen:a,setIsOpen:d}=ye(),[p,r]=M.useState(null),g=t=>{d(E,!0),r(t)},o=()=>{d(E,!1),r(null)},_=de({defaultValues:je(s.prices),resolver:ue(xe)}),{mutateAsync:P,isPending:m}=_e(s.id),{store:j,isLoading:V,isError:q,error:z}=pe(),S=M.useMemo(()=>{var t;return((t=j==null?void 0:j.supported_currencies)==null?void 0:t.map(I=>I.currency_code))||[]},[j]),{regions:f,isLoading:K,isError:G,error:$}=me({fields:"id,name,currency_code",limit:999}),{price_preferences:H}=fe({}),{setCloseOnEscape:Z}=B(),J=se({name:s.name,currencies:S,regions:f,pricePreferences:H}),Q=M.useMemo(()=>[[...S||[],...f||[]]],[S,f]),w=_.handleSubmit(async t=>{const I=Object.entries(t.currency_prices).map(([i,c])=>{if(!c||!S.some(C=>C.toLowerCase()===i.toLowerCase()))return;const l={currency_code:i,amount:R(c)},b=s.prices.find(C=>C.currency_code===i&&!C.price_rules.length);return b&&(l.id=b.id),l}).filter(i=>!!i),X=Object.entries(t.conditional_currency_prices).flatMap(([i,c])=>c==null?void 0:c.map(l=>({id:l.id,currency_code:i,amount:R(l.amount),rules:D(l)}))),Y=Object.entries(t.region_prices).map(([i,c])=>!c||!(f!=null&&f.some(b=>b.id===i))?void 0:{region_id:i,amount:R(c)}).filter(i=>!!i),ee=Object.entries(t.conditional_region_prices).flatMap(([i,c])=>c==null?void 0:c.map(l=>({id:l.id,region_id:i,amount:R(l.amount),rules:D(l)}))),re=[...I,...X,...Y,...ee];await P({prices:re},{onSuccess:()=>{N.success(e("general.success")),u()},onError:i=>{N.error(i.message)}})}),W=V||K||!S||!f;if(q)throw z;if(G)throw $;return n.jsx(y.Form,{form:_,children:n.jsxs(he,{className:"flex h-full flex-col overflow-hidden",onSubmit:w,children:[n.jsx(y.Header,{}),n.jsx(y.Body,{children:n.jsx(Se,{id:E,onOpenChangeCallback:t=>{t||r(null)},children:n.jsxs(ie,{onOpenConditionalPricesModal:g,onCloseConditionalPricesModal:o,children:[n.jsx("div",{className:"flex size-full flex-col divide-y overflow-hidden",children:n.jsx(oe,{isLoading:W,data:Q,columns:J,state:_,onEditingChange:t=>Z(!t),disableInteractions:a(E)})}),p&&n.jsx(ne,{info:p,variant:"update"})]})})}),n.jsx(y.Footer,{children:n.jsxs("div",{className:"flex items-center justify-end gap-x-2",children:[n.jsx(y.Close,{asChild:!0,children:n.jsx(k,{variant:"secondary",size:"small",children:e("actions.cancel")})}),n.jsx(k,{size:"small",className:"whitespace-nowrap",isLoading:m,onClick:w,type:"button",children:e("actions.save")})]})})]})})}var x=(s,e)=>{var a;const u=["eq","gt","lt"].includes(e)?void 0:null;return((a=s==null?void 0:s.find(d=>d.attribute===T&&d.operator===e))==null?void 0:a.value)||u},U=s=>{const e=s.price_rules||[];return{id:s.id,amount:s.amount,gte:x(e,"gte"),lte:x(e,"lte"),gt:x(e,"gt"),lt:x(e,"lt"),eq:x(e,"eq")}},je=s=>{const e=(r,g,o=[])=>{var P;const _=((P=r.price_rules)==null?void 0:P.map(m=>m.attribute))||[];return g.every(m=>_.includes(m))&&!o.some(m=>_.includes(m))},u={},a={},d={},p={};return s.forEach(r=>{var g;if(!((g=r.price_rules)!=null&&g.length)){u[r.currency_code]=r.amount;return}if(e(r,[T],[L])){const o=r.currency_code;a[o]||(a[o]=[]),a[o].push(U(r));return}if(e(r,[L],[T])){const o=r.price_rules[0].value;d[o]=r.amount;return}if(e(r,[L,T])){const o=r.price_rules[0].value;p[o]||(p[o]=[]),p[o].push(U(r))}}),{currency_prices:u,conditional_currency_prices:a,region_prices:d,conditional_region_prices:p}};function Ve(){const{so_id:s,location_id:e}=ce();if(!s)throw ae({message:"Shipping Option ID paramater is missing",status:404});const{shipping_option:u,isError:a,error:d}=ge(s,{fields:"*prices,*prices.price_rules"});if(a)throw d;return n.jsx(y,{prev:`/settings/locations/${e}`,children:u&&n.jsx(Pe,{shippingOption:u})})}export{Ve as Component};
